<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
Â  <meta charset="utf-8" />
Â  <title>Media Prospect Manager</title>
Â  <base target="_top">
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <meta name="description" content="Manage and track media outreach prospects with a real-time Supabase database.">

Â  <script defer src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>

Â  <script>
Â  Â  console.log("App script running. Is Supabase ready?", typeof supabase);
Â  Â  if (typeof supabase === 'undefined') {
Â  Â  Â  Â  alert("CRITICAL ERROR: Supabase library failed to load before app script!");
Â  Â  }

Â  Â  // Supabase Initialization
Â  Â  const { createClient } = supabase;
Â  Â  const supabaseClient = createClient(
Â  Â  Â  'https://mfjymrrykhvfkivtvgit.supabase.co',
Â  Â  Â  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1manltcnJ5a2h2ZmtpdnR2Z2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNzY1MzksImV4cCI6MjA3NjY1MjUzOX0.wgn7fZgL8vmedKWmJ8BNfwbaOzZ4ZFltqcDrkEDvsnw'
Â  Â  );
Â  Â  console.log("supabaseClient created:", !!supabaseClient);

Â  Â  function prospectApp() {
Â  Â  Â  console.log("prospectApp function called by Alpine");

Â  Â  Â  return {
Â  Â  Â  Â  // --- Reactive Data ---
Â  Â  Â  Â  db: [],
Â  Â  Â  Â  campaigns: [],
Â  Â  Â  Â  statuses: [
Â  Â  Â  Â  Â  { value: 'unvetted', label: 'Unvetted' },
Â  Â  Â  Â  Â  { value: 'contacted', label: 'Contacted' },
Â  Â  Â  Â  Â  { value: 'interested', label: 'Interested' },
Â  Â  Â  Â  Â  { value: 'in_progress', label: 'In Progress' },
Â  Â  Â  Â  Â  { value: 'rejected', label: 'Rejected' },
Â  Â  Â  Â  Â  { value: 'secured', label: 'Secured' }
Â  Â  Â  Â  ],
Â  Â  Â  Â  showAddForm: false,
Â  Â  Â  Â  showNewCampaignInput: false,
Â  Â  Â  Â  newCampaignName: '',
Â  Â  Â  Â  addFormCampaign: '',
Â  Â  Â  Â  ingestSummary: { total: 0, newCount: 0, dupeCount: 0, invalidCount: 0 },
Â  Â  Â  Â  pasteInput: '',
Â  Â  Â  Â  search: '',
Â  Â  Â  Â  selectedCampaign: 'all',
Â  Â  Â  Â  filterStatus: '',
Â  Â  Â  Â  hideRejected: false,
        initialized: false, // Track initialization status

Â  Â  Â  Â  // --- Alpine Initialization Method (with delay fix) ---
Â  Â  Â  Â  async init() {
Â  Â  Â  Â  Â  console.log("Alpine init() called.");
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Safety check against multiple calls
Â  Â  Â  Â  Â  if (this.initialized) {
Â  Â  Â  Â  Â  Â  console.warn("Init called multiple times. Skipping initialization.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  this.initialized = true;

Â  Â  Â  Â  Â  if (!supabaseClient) {
Â  Â  Â  Â  Â  Â  console.error("Cannot init, supabaseClient is missing!");
Â  Â  Â  Â  Â  Â  alert("Initialization Error: Supabase client missing.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // 1. Load data and derive campaigns synchronously
Â  Â  Â  Â  Â  await this.load();
Â  Â  Â  Â  Â  this.deriveCampaigns();
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // 2. FIX: Introduce a small delay to prevent Realtime race condition on initial load
Â  Â  Â  Â  Â  console.log("Scheduling Realtime subscription with 10ms delay to prevent race condition.");
Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  this.initSubscription();
Â  Â  Â  Â  Â  }, 10);
Â  Â  Â  Â  },

Â  Â  Â  Â  // --- Methods ---
Â  Â  Â  Â  async load() {
Â  Â  Â  Â  Â  console.log("load() called.");
Â  Â  Â  Â  Â  if (!supabaseClient) { console.error("Load failed: supabaseClient missing"); return; }
Â  Â  Â  Â  Â  console.log("Loading initial data...");
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const { data, error, status } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  .from('mediadb')
Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  .order('created_at', { ascending: false });

Â  Â  Â  Â  Â  Â  if (error && status !== 406) {
Â  Â  Â  Â  Â  Â  Â  console.error('Error loading data:', status, error.message);
Â  Â  Â  Â  Â  Â  Â  alert('Error loading data. Check console.');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.log(`Data loaded successfully (${data?.length || 0} rows). Status: ${status}`);
Â  Â  Â  Â  Â  Â  Â  this.db = data || [];
Â  Â  Â  Â  Â  Â  Â  this.deriveCampaigns();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error("Exception during load():", err);
Â  Â  Â  Â  Â  Â  alert("Failed to load data due to an exception. Check console.");
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },

Â  Â  Â  Â  initSubscription() {
Â  Â  Â  Â  Â  console.log('initSubscription() called.');
Â  Â  Â  Â  Â  if (!supabaseClient) { console.error("Subscribe failed: supabaseClient missing"); return; }
Â  Â  Â  Â  Â  
            // Ensures a clean slate before subscribing
Â  Â  Â  Â  Â  supabaseClient.removeAllChannels(); 
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  console.log("Attempting to subscribe to real-time updates...");
Â  Â  Â  Â  Â  
            // Creates a new channel instance for a clean connection attempt
Â  Â  Â  Â  Â  const channel = supabaseClient.channel('public:mediadb');

Â  Â  Â  Â  Â  channel.on(
Â  Â  Â  Â  Â  Â  'postgres_changes',
Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: 'mediadb' },
Â  Â  Â  Â  Â  Â  (payload) => {
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Real-time change received!', payload.eventType, payload.new || payload.old);
Â  Â  Â  Â  Â  Â  Â  Â  this.handleRealtimeChange(payload);
Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("âŒ Error processing real-time event:", error, payload);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  ).subscribe((status, err) => {
Â  Â  Â  Â  Â  Â  if (status === 'SUBSCRIBED') {
Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Successfully subscribed to real-time updates!');
Â  Â  Â  Â  Â  Â  } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
Â  Â  Â  Â  Â  Â  Â  console.error(`âŒ Realtime connection ${status}:`, err || 'No error details provided.');
              
              // FIX: Explicitly unsubscribe to clean up the failed channel resource
              channel.unsubscribe();
              
Â  Â  Â  Â  Â  Â  Â  console.log('ðŸ”„ Attempting to re-subscribe in 5 seconds...');
Â  Â  Â  Â  Â  Â  Â  setTimeout(() => this.initSubscription(), 5000);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.info('â„¹ï¸ Realtime subscription status:', status);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  },

Â  Â  Â  Â  handleRealtimeChange(payload) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  let campaignListChanged = false;
Â  Â  Â  Â  Â  Â  const eventType = payload.eventType;
Â  Â  Â  Â  Â  Â  const newData = payload.new;
Â  Â  Â  Â  Â  Â  const oldData = payload.old;

Â  Â  Â  Â  Â  Â  console.log(`Handling Realtime ${eventType}...`);

Â  Â  Â  Â  Â  Â  if (eventType === 'INSERT') {
Â  Â  Â  Â  Â  Â  Â  if (!this.db.some(item => item.id === newData.id)) {
Â  Â  Â  Â  Â  Â  Â  Â  // Prepend new data to maintain "created_at descending" sort order
Â  Â  Â  Â  Â  Â  Â  Â  this.db = [newData, ...this.db];
Â  Â  Â  Â  Â  Â  Â  Â  if (newData.campaign && !this.campaigns.includes(newData.campaign)) campaignListChanged = true;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (eventType === 'UPDATE') {
Â  Â  Â  Â  Â  Â  Â  const index = this.db.findIndex(r => r.id === newData.id);
Â  Â  Â  Â  Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  // Use map for proper reactivity when updating an item
Â  Â  Â  Â  Â  Â  Â  Â  this.db = this.db.map(item => item.id === newData.id ? newData : item);
Â  Â  Â  Â  Â  Â  Â  Â  if (oldData.campaign !== newData.campaign || (newData.campaign && !this.campaigns.includes(newData.campaign))) campaignListChanged = true;
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // If update is for a row not in memory (e.g. initial load missed it), insert it.
Â  Â  Â  Â  Â  Â  Â  Â  this.db = [newData, ...this.db];
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (eventType === 'DELETE') {
Â  Â  Â  Â  Â  Â  Â  const initialLength = this.db.length;
Â  Â  Â  Â  Â  Â  Â  this.db = this.db.filter(r => r.id !== oldData.id);
Â  Â  Â  Â  Â  Â  Â  // Check if the campaign list might need recalculating if a campaign's last item was deleted
Â  Â  Â  Â  Â  Â  Â  if (this.db.length < initialLength) campaignListChanged = true;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (campaignListChanged) this.deriveCampaigns();
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error inside handleRealtimeChange logic:", error, payload);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },

Â  Â  Â  Â  deriveCampaigns() {
Â  Â  Â  Â  Â  const allCampaigns = this.db.map(r => r.campaign).filter(Boolean);
Â  Â  Â  Â  Â  const uniqueCampaigns = [...new Set(allCampaigns)].sort((a, b) => a.localeCompare(b));
Â  Â  Â  Â  Â  if (JSON.stringify(this.campaigns) !== JSON.stringify(uniqueCampaigns)) {
Â  Â  Â  Â  Â  Â  this.campaigns = uniqueCampaigns;
Â  Â  Â  Â  Â  Â  console.log("Updated campaigns list:", this.campaigns);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },

Â  Â  Â  Â  async ingest() {
Â  Â  Â  Â  Â  const campaignToAssign = this.addFormCampaign === 'unassigned' ? '' : this.addFormCampaign;
Â  Â  Â  Â  Â  if (!this.addFormCampaign) {
Â  Â  Â  Â  Â  Â  alert('Please select a campaign to assign these prospects to.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const lines = (this.pasteInput || '').split(/[\r\n]+/).map(l => l.trim()).filter(Boolean);
Â  Â  Â  Â  Â  if (lines.length === 0) {
Â  Â  Â  Â  Â  Â  alert('Paste input is empty or contains only whitespace.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  console.log(`Attempting to ingest ${lines.length} lines for campaign: ${campaignToAssign || 'Unassigned'}`);
Â  Â  Â  Â  Â  let newRows = [];
Â  Â  Â  Â  Â  let currentDomains = new Set(this.db.map(r => r.domain?.toLowerCase()));
Â  Â  Â  Â  Â  let skippedDupes = 0;
Â  Â  Â  Â  Â  let skippedInvalid = 0;

Â  Â  Â  Â  Â  for (const line of lines) {
Â  Â  Â  Â  Â  Â  const domain = this.normalizeDomain(line.split(/[,;\s\t]/)[0]);
Â  Â  Â  Â  Â  Â  if (!domain) {
Â  Â  Â  Â  Â  Â  Â  skippedInvalid++;
Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const lowerDomain = domain.toLowerCase();
Â  Â  Â  Â  Â  Â  if (currentDomains.has(lowerDomain) || newRows.some(r => r.domain.toLowerCase() === lowerDomain)) {
Â  Â  Â  Â  Â  Â  Â  skippedDupes++;
Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  newRows.push({ domain, campaign: campaignToAssign, status: 'unvetted' });
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const dupeCount = skippedDupes;
Â  Â  Â  Â  Â  const invalidCount = skippedInvalid;
Â  Â  Â  Â  Â  const newCount = newRows.length;
Â  Â  Â  Â  Â  this.ingestSummary = { total: lines.length, newCount, dupeCount, invalidCount };

Â  Â  Â  Â  Â  if (newCount > 0) {
Â  Â  Â  Â  Â  Â  // Note: Realtime will handle updating this.db, so no explicit push is needed here.
Â  Â  Â  Â  Â  Â  const { error } = await supabaseClient.from('mediadb').insert(newRows);
Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  console.error('Error creating prospects:', error.message);
Â  Â  Â  Â  Â  Â  Â  alert('Error creating prospects. Check console.');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  this.pasteInput = '';
Â  Â  Â  Â  Â  Â  Â  this.showAddForm = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert(`Processed ${lines.length} lines. Found ${dupeCount} duplicates and ${skippedInvalid} invalid entries. No new prospects added.`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },

Â  Â  Â  Â  async updateProspect(p) {
Â  Â  Â  Â  Â  // Note: Realtime will handle updating this.db, so no manual array manipulation is needed here.
Â  Â  Â  Â  Â  const { error } = await supabaseClient
Â  Â  Â  Â  Â  Â  .from('mediadb')
Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  status: p.status,
Â  Â  Â  Â  Â  Â  Â  contact: p.contact,
Â  Â  Â  Â  Â  Â  Â  notes: p.notes,
Â  Â  Â  Â  Â  Â  Â  campaign: p.campaign
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .eq('id', p.id);

Â  Â  Â  Â  Â  if (error) alert('Error updating prospect. Check console.');
Â  Â  Â  Â  Â  // Realtime will take care of campaign change, but a dedicated re-derive is not wrong
Â  Â  Â  Â  Â  // else if (p.campaign && !this.campaigns.includes(p.campaign)) this.deriveCampaigns();
Â  Â  Â  Â  },

Â  Â  Â  Â  async deleteProspect(id) {
Â  Â  Â  Â  Â  if (!confirm(`Are you sure you want to delete prospect ID: ${id}?`)) return;
Â  Â  Â  Â  Â  // Note: Realtime will handle updating this.db
Â  Â  Â  Â  Â  const { error } = await supabaseClient.from('mediadb').delete().eq('id', id);
Â  Â  Â  Â  Â  if (error) alert('Error deleting prospect. Check console.');
Â  Â  Â  Â  },

Â  Â  Â  Â  normalizeDomain(input) {
Â  Â  Â  Â  Â  let s = (input || '').trim().toLowerCase();
Â  Â  Â  Â  Â  s = s.replace(/^(?:https?:\/\/|ftp:\/\/)?(?:www\.)?/i, '');
Â  Â  Â  Â  Â  s = s.replace(/^[^@]+@/, '');
Â  Â  Â  Â  Â  s = s.split(/[:/?#]/)[0];
Â  Â  Â  Â  Â  s = s.replace(/\.$/, '');
Â  Â  Â  Â  Â  if (!/^[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?)+$/i.test(s)) return null;
Â  Â  Â  Â  Â  return s;
Â  Â  Â  Â  },

Â  Â  Â  Â  addNewCampaign() {
Â  Â  Â  Â  Â  const name = this.newCampaignName.trim();
Â  Â  Â  Â  Â  if (!name) { alert('Please enter a valid campaign name.'); return; }
Â  Â  Â  Â  Â  if (this.campaigns.some(c => c.toLowerCase() === name.toLowerCase())) {
Â  Â  Â  Â  Â  Â  alert(`Campaign "${name}" already exists.`);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  this.campaigns.push(name);
Â  Â  Â  Â  Â  this.campaigns.sort((a, b) => a.localeCompare(b));
Â  Â  Â  Â  Â  this.addFormCampaign = name;
Â  Â  Â  Â  Â  this.newCampaignName = '';
Â  Â  Â  Â  Â  this.showNewCampaignInput = false;
Â  Â  Â  Â  },

Â  Â  Â  Â  get filtered() {
Â  Â  Â  Â  Â  let rows = this.db;
Â  Â  Â  Â  Â  if (this.selectedCampaign === '') {
Â  Â  Â  Â  Â  Â  rows = rows.filter(r => !r.campaign);
Â  Â  Â  Â  Â  } else if (this.selectedCampaign !== 'all') {
Â  Â  Â  Â  Â  Â  rows = rows.filter(r => r.campaign === this.selectedCampaign);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (this.filterStatus) rows = rows.filter(r => r.status === this.filterStatus);
Â  Â  Â  Â  Â  if (this.hideRejected) rows = rows.filter(r => r.status !== 'rejected');
Â  Â  Â  Â  Â  const q = (this.search || '').trim().toLowerCase();
Â  Â  Â  Â  Â  if (q) {
Â  Â  Â  Â  Â  Â  rows = rows.filter(r =>
Â  Â  Â  Â  Â  Â  Â  (r.domain?.toLowerCase() || '').includes(q) ||
Â  Â  Â  Â  Â  Â  Â  (r.contact?.toLowerCase() || '').includes(q) ||
Â  Â  Â  Â  Â  Â  Â  (r.notes?.toLowerCase() || '').includes(q) ||
Â  Â  Â  Â  Â  Â  Â  (r.campaign?.toLowerCase() || '').includes(q)
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // NOTE: Data is already sorted by created_at descending from initial load/realtime,
Â  Â  Â  Â  Â  // so no need to re-sort unless filtering changes the order preference.
Â  Â  Â  Â  Â  return rows;
Â  Â  Â  Â  },

Â  Â  Â  Â  countByStatus(status) {
Â  Â  Â  Â  Â  let relevantData = this.db;
Â  Â  Â  Â  Â  if (this.selectedCampaign === '') {
Â  Â  Â  Â  Â  Â  relevantData = this.db.filter(r => !r.campaign);
Â  Â  Â  Â  Â  } else if (this.selectedCampaign !== 'all') {
Â  Â  Â  Â  Â  Â  relevantData = this.db.filter(r => r.campaign === this.selectedCampaign);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return relevantData.filter(r => r.status === status).length;
Â  Â  Â  Â  },

Â  Â  Â  Â  formatDate(iso) {
Â  Â  Â  Â  Â  if (!iso) return 'N/A';
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const d = new Date(iso);
Â  Â  Â  Â  Â  Â  return d.toLocaleString(undefined, {
Â  Â  Â  Â  Â  Â  Â  year: 'numeric', month: 'numeric', day: 'numeric',
Â  Â  Â  Â  Â  Â  Â  hour: '2-digit', minute: '2-digit'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  return 'Invalid Date';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },

Â  Â  Â  Â  exportCSV(all) {
Â  Â  Â  Â  Â  let rowsToExport;
Â  Â  Â  Â  Â  let campaignName = 'all_campaigns';
Â  Â  Â  Â  Â  if (this.selectedCampaign === '') { campaignName = 'unassigned'; }
Â  Â  Â  Â  Â  else if (this.selectedCampaign !== 'all') { campaignName = this.selectedCampaign.replace(/[^a-z0-9]/gi, '_').toLowerCase(); }

Â  Â  Â  Â  Â  if (all) {
Â  Â  Â  Â  Â  Â  rowsToExport = this.selectedCampaign !== 'all'
Â  Â  Â  Â  Â  Â  Â  ? this.db.filter(r => this.selectedCampaign === '' ? !r.campaign : r.campaign === this.selectedCampaign)
Â  Â  Â  Â  Â  Â  Â  : this.db.slice();
Â  Â  Â  Â  Â  Â  // Ensure all rows are sorted consistently for "Export All"
Â  Â  Â  Â  Â  Â  rowsToExport.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));Â 
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  rowsToExport = this.filtered;
Â  Â  Â  Â  Â  Â  if (this.selectedCampaign !== 'all') campaignName = `filtered_${campaignName}`;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (!rowsToExport || rowsToExport.length === 0) {
Â  Â  Â  Â  Â  Â  alert("No data available to export for the current selection.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const headers = ['id', 'domain', 'status', 'contact', 'notes', 'created_at', 'campaign'];
Â  Â  Â  Â  Â  const escape = v => `"${String(v === null || v === undefined ? '' : v).replace(/"/g, '""')}"`;
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const csv = [headers.join(',')].concat(rowsToExport.map(r => headers.map(h => escape(r[h])).join(','))).join('\n');
Â  Â  Â  Â  Â  Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  Â  a.download = `prospects_${campaignName}_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
Â  Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  alert("Failed to generate CSV. Check console for details.");
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  }

Â  Â  console.log("prospectApp function defined:", typeof prospectApp === 'function');
Â  </script>

Â  <style>
Â  Â  td, th { white-space: nowrap; }
Â  Â  td textarea { min-height: 2.25rem; }
Â  </style>
</head>

<body class="h-full bg-gray-50 text-gray-900">
Â  Â  <div class="max-w-7xl mx-auto p-4" x-data="prospectApp()" x-init="init()">Â 
Â  Â  <div class="flex items-start sm:items-center justify-between gap-4 flex-col sm:flex-row">
Â  Â  Â  <div>
Â  Â  Â  Â  <h1 class="text-2xl font-semibold">Media Prospect Manager</h1>
Â  Â  Â  Â  <p class="text-sm text-gray-600">Now powered by Supabase (realtime enabled and stable).</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  <button @click="exportCSV(false)" class="px-3 py-2 text-sm rounded-md border bg-white hover:bg-gray-50">Export Filtered CSV</button>
Â  Â  Â  Â  <button @click="exportCSV(true)" class="px-3 py-2 text-sm rounded-md border bg-white hover:bg-gray-50">Export All CSV</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mt-4">
Â  Â  Â  <template x-for="s in statuses" :key="s.value">
Â  Â  Â  Â  <div class="rounded-lg border bg-white p-3">
Â  Â  Â  Â  Â  <div class="text-xs text-gray-500" x-text="s.label"></div>
Â  Â  Â  Â  Â  <div class="text-xl font-semibold" x-text="countByStatus(s.value)"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </template>
Â  Â  </div>

Â  Â  <div class="mt-6 text-right">
Â  Â  Â  <button @click="showAddForm = true" x-show="!showAddForm" class="px-4 py-2 rounded-md text-white bg-gray-900 hover:bg-gray-800">
Â  Â  Â  Â  Add New Prospects
Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div class="mt-6 rounded-lg border bg-white p-4" x-show="showAddForm" x-transition>
Â  Â  Â  <div class="flex justify-between items-center mb-3">
Â  Â  Â  Â  <h2 class="font-medium">Add Prospects (Paste Only)</h2>
Â  Â  Â  Â  <button @click="showAddForm = false; ingestSummary = { total: 0 }; pasteInput = ''" class="text-sm text-gray-600 hover:underline">Cancel</button>
Â  Â  Â  Â  </div>

Â  Â  Â  <div class="grid md:grid-cols-3 gap-3">
Â  Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  Â  <label class="block text-sm text-gray-700 mb-1">Paste list of domains or URLs (one per line)</label>
Â  Â  Â  Â  Â  <textarea x-model="pasteInput" placeholder="example.com&#10;https://www.site.com/about&#10;blog.domain.co.uk" class="w-full border rounded-md p-2 h-32"></textarea>
Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mt-1">Cleans to root domains, lowercases, and skips duplicates. Assign a campaign on the right.</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label class="block text-sm text-gray-700 mb-1 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  <span>Assign to Campaign</span>
Â  Â  Â  Â  Â  Â  <button @click="showNewCampaignInput = !showNewCampaignInput" x-show="!showNewCampaignInput" class="text-xs text-blue-600 hover:underline focus:outline-none">
Â  Â  Â  Â  Â  Â  Â  + New
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  <select x-model="addFormCampaign" class="w-full border rounded-md p-2">
Â  Â  Â  Â  Â  Â  <option value="">-- Select Campaign --</option>
Â  Â  Â  Â  Â  Â  <template x-for="campaign in campaigns" :key="campaign">
Â  Â  Â  Â  Â  Â  Â  <option :value="campaign" x-text="campaign"></option>
Â  Â  Â  Â  Â  Â  </template>
Â  Â  Â  Â  Â  Â  <option value="unassigned">Unassigned</option>
Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  <div x-show="showNewCampaignInput" class="mt-2 flex gap-2" x-transition>
Â  Â  Â  Â  Â  Â  <input type="text" x-model="newCampaignName" placeholder="New campaign name..." class="flex-grow border rounded-md p-1 text-sm">
Â  Â  Â  Â  Â  Â  <button @click="addNewCampaign()" class="px-2 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">Add</button>
Â  Â  Â  Â  Â  Â  <button @click="showNewCampaignInput = false; newCampaignName = ''" class="px-2 py-1 text-sm text-gray-600 hover:underline">Cancel</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <button @click="ingest()" class="mt-4 w-full px-3 py-2 rounded-md text-white bg-gray-900 hover:bg-gray-800">
Â  Â  Â  Â  Â  Â  Add Prospects
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <template x-if="ingestSummary.total > 0">
Â  Â  Â  Â  <div class="mt-3 text-sm">
Â  Â  Â  Â  Â  <span class="inline-block mr-3">Total Lines: <strong x-text="ingestSummary.total"></strong></span>
Â  Â  Â  Â  Â  <span class="inline-block mr-3 text-green-700">Added: <strong x-text="ingestSummary.newCount"></strong></span>
Â  Â  Â  Â  Â  <span class="inline-block mr-3 text-amber-700">Duplicates: <strong x-text="ingestSummary.dupeCount"></strong></span>
Â  Â  Â  Â  Â  <span class="inline-block text-red-700" x-show="ingestSummary.invalidCount > 0">Invalid/Skipped: <strong x-text="ingestSummary.invalidCount"></strong></span>
Â  Â  Â  Â  </div>
Â  Â  Â  </template>
Â  Â  </div>

Â  Â  <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-3">
Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  <label class="text-sm text-gray-700">Search</label>
Â  Â  Â  Â  <input type="search" x-model.debounce.300ms="search" placeholder="Search domain, contact info, notes, or campaign..." class="w-full border rounded-md p-2" />
Â  Â  Â  Â  </div>

Â  Â  Â  <div>
Â  Â  Â  Â  <label class="text-sm text-gray-700">Filter by Campaign</label>
Â  Â  Â  Â  <select x-model="selectedCampaign" class="w-full border rounded-md p-2">
Â  Â  Â  Â  Â  <option value="all">All Campaigns</option>
Â  Â  Â  Â  Â  <template x-for="campaign in campaigns" :key="campaign">
Â  Â  Â  Â  Â  Â  <option :value="campaign" x-text="campaign"></option>
Â  Â  Â  Â  Â  </template>
Â  Â  Â  Â  Â  <option value="">Unassigned</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div>
Â  Â  Â  Â  <label class="text-sm text-gray-700">Filter by Status</label>
Â  Â  Â  Â  <select x-model="filterStatus" class="w-full border rounded-md p-2">
Â  Â  Â  Â  Â  <option value="">All</option>
Â  Â  Â  Â  Â  <template x-for="s in statuses" :key="'filter-'+s.value">
Â  Â  Â  Â  Â  Â  <option :value="s.value" x-text="s.label"></option>
Â  Â  Â  Â  Â  </template>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="flex items-end">
Â  Â  Â  Â  <label class="inline-flex items-center gap-2">
Â  Â  Â  Â  Â  <input type="checkbox" x-model="hideRejected" class="rounded border-gray-300">
Â  Â  Â  Â  Â  <span class="text-sm">Hide Rejected</span>
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="mt-4 overflow-auto rounded-lg border bg-white">
Â  Â  Â  <table class="min-w-full text-sm">
Â  Â  Â  Â  <thead class="bg-gray-50 text-gray-600">
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th class="p-2 text-left">Domain</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 text-left">Status</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 text-left">Contact Info</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 text-left">Notes</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 text-left">Date Added</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 text-left">Campaign</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 text-left">Actions</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  <template x-if="!db || db.length === 0">
Â  Â  Â  Â  Â  Â  <tr><td colspan="7" class="p-4 text-center text-gray-500">Loading prospects or none found...</td></tr>
Â  Â  Â  Â  Â  </template>
Â  Â  Â  Â  Â  <template x-if="db && db.length > 0 && filtered.length === 0">
Â  Â  Â  Â  Â  Â  <tr><td colspan="7" class="p-4 text-center text-gray-500">No prospects match your current filters.</td></tr>
Â  Â  Â  Â  Â  </template>
Â  Â  Â  Â  Â  <template x-for="p in filtered" :key="p.id">
Â  Â  Â  Â  Â  Â  <tr class="border-t hover:bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  <td class="p-2 font-medium"><a :href="'http://' + p.domain" target="_blank" x-text="p.domain" class="text-blue-600 hover:underline"></a></td>
Â  Â  Â  Â  Â  Â  Â  <td class="p-2">
Â  Â  Â  Â  Â  Â  Â  Â  <select class="border rounded-md p-1 text-xs" x-model="p.status" @change="updateProspect(p)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <template x-for="s in statuses" :key="s.value">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option :value="s.value" x-text="s.label"></option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </template>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  <td class="p-2"><input type="text" class="w-48 max-w-full border rounded-md p-1 text-xs" x-model.lazy="p.contact" @change="updateProspect(p)"></td>
Â  Â  Â  Â  Â  Â  Â  <td class="p-2"><textarea class="w-64 max-w-full border rounded-md p-1 text-xs" x-model.lazy="p.notes" @change="updateProspect(p)"></textarea></td>
Â  Â  Â  Â  Â  Â  Â  <td class="p-2 text-gray-600 text-xs" x-text="formatDate(p.created_at)"></td>
Â  Â  Â  Â  Â  Â  Â  <td class="p-2">
Â  Â  Â  Â  Â  Â  Â  Â  <select class="border rounded-md p-1 text-xs" x-model="p.campaign" @change="updateProspect(p)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Unassigned</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <template x-for="cName in campaigns" :key="cName">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option :value="cName" x-text="cName"></option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </template>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  <td class="p-2">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="text-xs text-red-600 hover:underline" @click="deleteProspect(p.id)">Delete</button>
Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </template>
Â  Â  Â  Â  </tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  </div>

Â  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>
